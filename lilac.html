<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Lilac README</title>
    <style>

body {
  margin: auto;
  padding-left: 1em;
  padding-right: 1em;
  max-width: 40em;
  font-family: sans-serif;
}

:link {
  text-decoration: none;
  color: blue
}

:visited {
  text-decoration: none;
  color: blue
}

    </style>
  </head>
  <body>

<h1>Lilac README</h1>

<p><i>Written by Noah Johnson</i><br/>
<tt><a href="https://www.canidlogic.com/">www.canidlogic.com</a></tt><br/>
<tt>noah.johnson@loupmail.com</tt><br/>
<tt>2019-11-11 / 3Y:84-1</tt></p>

<h2>1. Introduction</h2>

<p>Lilac is a program for synthesizing color drawings out of separate image components.</p>

<h2>2. Syntax</h2>

<p>The syntax of the Lilac program is:</p>

<blockquote>
<tt>lilac [out] [mask] [pencil] [shading] [table] [texture_1] ... [texture_n]</tt>
</blockquote>

<p>The <tt>[out]</tt> parameter is the path to write the output image file.  The path must have an image format extension recognized by the Sophistry library.  PNG output is strongly recommended because JPEG doesn't support transparency.  If JPEG is specified, the quality will be set to 90.</p>

<p>The <tt>[mask]</tt> parameter is the path to an image file to read as a mask file.  The path must have an image format extension recognized by the Sophistry library.</p>

<p>The <tt>[pencil]</tt> parameter is the path to an image file to read as the pencil file.  The path must have an image format extension recognized by the Sophistry library.</p>

<p>The <tt>[shading]</tt> parameter is the path to an image file to read as the shading file.  The path must have an image format extension recognized by the Sophistry library.</p>

<p>The <tt>[table]</tt> parameter is the path to a text file specifying shading information.  The format of this file is described later.</p>

<p>The <tt>[texture_1] ... [texture_n]</tt> is an array of parameters specifying paths to image files to read as texture files.  Each path must have an image format extension recognized by the Sophistry library.  There must be at least two textures.</p>

<h3>2.1 Table file syntax</h3>

<p>The table file is a plain-text ASCII text file with the following syntax.</p>

<p>The table file is read line-by-line.  Each line ends with CR+LF, LF, or the end of the file.  Each line, not including the line break, must fit within 255 characters.</p>

<p>Lines that are empty or consist only of spaces and horizontal tabs are blank lines.  Blank lines are ignored.</p>

<p>Lines for which the very first character is a <tt>#</tt> are comment lines and are ignored.</p>

<p>All other lines are shading records, which must have the following format:</p>

<ol>
<li>RGB shading index</li>
<li><i>whitespace</i></li>
<li>Texture index</li>
<li><i>whitespace</i></li>
<li>Shading rate</li>
<li><i>whitespace</i></li>
<li>RGB tint</li>
<li><i>optional whitespace</i></li>
</ol>

<p>The <i>whitespace</i> lines mean at least one space or tab character, while the <i>optional whitespace</i> line means zero or more space or tab characters.  Note that no whitespace is allowed at the beginning of the line.</p>

<p>The two RGB lines are specified as exactly six base-16 digits (uppercase or lowercase letters) specifying RRGGBB.  The shading index is the RGB color within the shading image file that selects this particular record.  The tint is the RGB color used for the colorization step (see later).</p>

<p>The texture index is an unsigned integer that selects one of the texture files that was passed to the Lilac program.  A value of one selects the first texture file, two selects the second, and so forth.</p>

<p>The shading rate is an unsigned integer in range zero to 255 that indicates the opacity of the brush texture, with zero meaning a completely transparent brush texture and 255 meaning a completely opaque brush texture.</p>

<p>The table file may have zero or more shading records.  If any RGB color in the shading image does not have a corresponding entry in the table, a default record is assumed, which has a texture index of one, a shading rate of zero, and an RGB tint of pure white.</p>

<p>The meaning of the table is explained more fully in the section detailing the program operation.</p>

<h2>3. Operation</h2>

<p>Lilac begins by reading all texture files fully into memory.  Note that this means that texture files should be kept as small as possible to avoid hitting memory limits.  Lilac will automatically tile textures so that they cover the entire image.  It is therefore possible to only use a small pattern for each texture which will then automatically be tiled to the full image size.  Textures may include transparent pixels.</p>

<p>Next, the table file is read and parsed into zero or more records, indexed by RGB color values.  Each record must have a unique RGB color value or there will be an error.</p>

<p>The mask, pencil, and shading images are then opened simultaneously.  They must each have the exact same image dimensions, or there will be an error.  The mask and pencil files are down-converted to black-and-white images by first compositing any transparent pixels over a pure white background to remove alpha, then converting RGB to grayscale if necessary, and finally thresholding with values 128 and greater being black and values 127 and lower being white.  The shading image is down-converted to RGB by compositing any transparent pixels over a pure white background to remove alpha.</p>

<p>The output file is opened, with the same dimensions as the mask, pencil, and shading images.  The images are processed pixel-by-pixel, with the pixel in the output file determined entirely by the corresponding pixels in the mask, pencil, and shading images.</p>

<p>If the mask file is a white pixel, then the output pixel is fully transparent.</p>

<p>If the mask file is a black pixel and the pencil file is a black pixel, then the output pixel is the corresponding pixel in the second texture, composited over the corresponding pixel in the first texture, composited over pure white, and then passed through the colorizer (described below).</p>

<p>If the mask file is a black pixel and the pencil file is a white pixel, then the output pixel is determined the following way.  First, the RGB value in the shading image is used to select a record in the shading table (or the default record if a corresponding RGB is not found).  Then, the corresponding pixel in the texture selected by the shading record is composited over the first texture with the transparency of the top texture multiplied by the shading rate transparency.  Any remaining transparent pixels are then composited over pure white.  Finally, the pixel is passed through the colorizer (described below).</p>

<p>The colorizer begins by converting the input color to a grayscale value.  Then, the colorizer uses the RGB value in the shading image to select a record in the shading table (or the default record if a corresponding RGB is not found).  The RGB value given for the tint is converted into the HSL (Hue Saturation Lightness) colorspace.  The lightness component is then replaced with the grayscale value coming from input.  The adjusted HSL value is then converted back to RGB for the final output value.</p>

<h2>4. Limitations</h2>

<p>The current version of Sophistry does not support JPEG.  However, if Lilac is linked against a future version of Sophistry that does support JPEG, then Lilac will support JPEG, too.</p>

<h2>5. Compilation</h2>

<p>The sophistry library is required.  The math library may be required on certain platforms.  Also link against the PNG library and any other libraries required by sophistry.</p>

<p style="margin-top: 2.5em;">&nbsp;</p>

  </body>
</html>